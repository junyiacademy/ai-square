name: Preview Deploy (Per-Issue Test Environment)

on:
  push:
    branches:
      - 'fix/issue-**'    # Matches fix/issue-27, fix/issue-28, etc.
      - 'feat/issue-**'   # Matches feat/issue-1, feat/issue-2, etc.
  pull_request:
    types: [closed]       # Clean up when PR is closed/merged

env:
  PROJECT_ID: ai-square-463013
  REGION: asia-east1
  NODE_OPTIONS: "--max-old-space-size=4096"

jobs:
  # Detect changes - skip if only docs
  detect-changes:
    name: Detect Changed Files
    runs-on: ubuntu-latest
    outputs:
      docs-only: ${{ steps.changes.outputs.docs-only }}
      has-code-changes: ${{ steps.changes.outputs.has-code-changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect file changes
        id: changes
        run: |
          echo "ğŸ” Analyzing changed files..."

          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD 2>/dev/null || echo "")

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes detected, treating as code change"
            echo "docs-only=false" >> $GITHUB_OUTPUT
            echo "has-code-changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          CODE_CHANGED=false

          while IFS= read -r file; do
            if [ -n "$file" ]; then
              if ! echo "$file" | grep -qE "^docs/" && \
                 ! echo "$file" | grep -qE "README" && \
                 ! echo "$file" | grep -qE "CHANGELOG" && \
                 ! echo "$file" | grep -qE "\.md$" && \
                 ! echo "$file" | grep -qE "\.txt$" && \
                 ! echo "$file" | grep -qE "LICENSE"; then
                CODE_CHANGED=true
                echo "ğŸ”„ Non-docs file detected: $file"
                break
              fi
            fi
          done <<< "$CHANGED_FILES"

          if [ "$CODE_CHANGED" = false ]; then
            echo "docs-only=true" >> $GITHUB_OUTPUT
            echo "has-code-changes=false" >> $GITHUB_OUTPUT
            echo "âœ… Only documentation changes - skipping preview deployment"
          else
            echo "docs-only=false" >> $GITHUB_OUTPUT
            echo "has-code-changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Code changes detected - deploying preview environment"
          fi

  # Deploy preview environment
  deploy-preview:
    name: Deploy Preview Environment
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      github.event_name == 'push' &&
      needs.detect-changes.outputs.docs-only == 'false' &&
      (startsWith(github.ref, 'refs/heads/fix/issue-') || startsWith(github.ref, 'refs/heads/feat/issue-'))

    outputs:
      preview-url: ${{ steps.deploy.outputs.url }}
      service-name: ${{ steps.extract-info.outputs.service-name }}
      issue-number: ${{ steps.extract-info.outputs.issue-number }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract issue number and service name
        id: extract-info
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          echo "Branch: $BRANCH_NAME"

          # Extract issue number from branch name (fix/issue-27 â†’ 27)
          ISSUE_NUMBER=$(echo "$BRANCH_NAME" | grep -oP '(?<=issue-)\d+' || echo "")

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "âŒ Could not extract issue number from branch: $BRANCH_NAME"
            exit 1
          fi

          # Create service name: ai-square-preview-issue-27
          SERVICE_NAME="ai-square-preview-issue-${ISSUE_NUMBER}"

          echo "issue-number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "service-name=$SERVICE_NAME" >> $GITHUB_OUTPUT

          echo "ğŸ“ Issue Number: $ISSUE_NUMBER"
          echo "ğŸ“ Service Name: $SERVICE_NAME"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci --prefer-offline

      - name: Build application (Skip tests for fast preview)
        working-directory: ./frontend
        env:
          NEXT_PUBLIC_APP_URL: "https://${{ steps.extract-info.outputs.service-name }}-731209836128.${{ env.REGION }}.run.app"
          NEXT_PUBLIC_API_URL: "https://${{ steps.extract-info.outputs.service-name }}-731209836128.${{ env.REGION }}.run.app/api"
        run: |
          echo "ğŸ—ï¸ Building for preview environment (skipping tests for speed)..."
          npm run build

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker gcr.io

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile.staging
          push: true
          tags: |
            gcr.io/${{ env.PROJECT_ID }}/${{ steps.extract-info.outputs.service-name }}:${{ github.sha }}
            gcr.io/${{ env.PROJECT_ID }}/${{ steps.extract-info.outputs.service-name }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Set IMAGE_NAME env var
        run: |
          SERVICE_NAME="${{ steps.extract-info.outputs.service-name }}"
          echo "IMAGE_NAME=gcr.io/${{ env.PROJECT_ID }}/${SERVICE_NAME}:${{ github.sha }}" >> $GITHUB_ENV

      - name: Deploy to Cloud Run (Preview)
        id: deploy
        run: |
          SERVICE_NAME="${{ steps.extract-info.outputs.service-name }}"
          ISSUE_NUMBER="${{ steps.extract-info.outputs.issue-number }}"

          echo "ğŸš€ Deploying preview environment for Issue #$ISSUE_NUMBER"

          # Create env vars file (use staging database)
          cat > /tmp/preview-env-vars.yaml << 'EOF'
          NODE_ENV: "staging"
          DATABASE_URL: "postgresql://postgres:${{ secrets.STAGING_DB_PASSWORD }}@/ai_square_db?host=/cloudsql/ai-square-463013:asia-east1:ai-square-db-staging-asia&connection_limit=5&pool_timeout=10"
          DB_HOST: "/cloudsql/ai-square-463013:asia-east1:ai-square-db-staging-asia"
          DB_NAME: "ai_square_db"
          DB_USER: "postgres"
          DB_PASSWORD: "${{ secrets.STAGING_DB_PASSWORD }}"
          NEXTAUTH_SECRET: "${{ secrets.NEXTAUTH_SECRET }}"
          NEXTAUTH_URL: "https://${{ steps.extract-info.outputs.service-name }}-731209836128.asia-east1.run.app"
          GOOGLE_CLOUD_PROJECT: "ai-square-463013"
          GCP_PROJECT_ID: "ai-square-463013"
          VERTEX_AI_LOCATION: "us-central1"
          VERTEX_AI_PROJECT: "ai-square-463013"
          VERTEX_AI_MODEL: "gemini-2.5-flash"
          VERTEX_AI_SERVICE_ACCOUNT_JSON: '${{ secrets.VERTEX_AI_KEY }}'
          REDIS_ENABLED: "false"
          SMTP_HOST: "smtp.gmail.com"
          SMTP_PORT: "587"
          SMTP_USER: "${{ secrets.SMTP_USER }}"
          SMTP_PASS: "${{ secrets.SMTP_PASS }}"
          SMTP_FROM: "AI Square <ai-square@junyiacademy.org>"
          APP_BASE_URL: "https://${{ steps.extract-info.outputs.service-name }}-731209836128.asia-east1.run.app"
          EOF

          gcloud run deploy "$SERVICE_NAME" \
            --image "$IMAGE_NAME" \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --min-instances 0 \
            --max-instances 2 \
            --memory 1Gi \
            --cpu 1 \
            --timeout 300 \
            --service-account=ai-square-staging@ai-square-463013.iam.gserviceaccount.com \
            --add-cloudsql-instances=ai-square-463013:asia-east1:ai-square-db-staging-asia \
            --env-vars-file=/tmp/preview-env-vars.yaml \
            --tag "issue-${ISSUE_NUMBER}" \
            --labels "environment=preview,issue=${ISSUE_NUMBER},managed-by=github-actions"

          # Clean up
          rm -f /tmp/preview-env-vars.yaml

          # Get the service URL
          SERVICE_URL=$(gcloud run services describe "$SERVICE_NAME" \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')

          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT

          echo "âœ… Preview environment deployed!"
          echo "ğŸ“ URL: $SERVICE_URL"

      - name: Comment on Issue with Preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.extract-info.outputs.issue-number }};
            const previewUrl = '${{ steps.deploy.outputs.url }}';
            const serviceName = '${{ steps.extract-info.outputs.service-name }}';
            const sha = context.sha.substring(0, 7);

            const comment = `## ğŸš€ Preview Environment Ready!

            **Issue #${issueNumber}** ã®å°‚ç”¨ãƒ†ã‚¹ãƒˆç’°å¢ƒãŒæº–å‚™ã§ãã¾ã—ãŸï¼š

            ### ğŸ“ Preview URL
            ğŸ”— **${previewUrl}**

            ### ğŸ“Š ç’°å¢ƒæƒ…å ±
            - **Service**: \`${serviceName}\`
            - **Commit**: \`${sha}\`
            - **Region**: \`${{ env.REGION }}\`
            - **Auto-cleanup**: PR ãŒã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã‚‹ã¨è‡ªå‹•å‰Šé™¤

            ### ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹æ³•
            1. ä¸Šè¨˜ã® URL ã«ã‚¢ã‚¯ã‚»ã‚¹
            2. ä¿®æ­£å†…å®¹ã‚’ç¢ºèª
            3. å•é¡Œãªã‘ã‚Œã°ã“ã® Issue ã«ã€Œæ¸¬è©¦é€šéã€ã¾ãŸã¯ã€ŒLGTMã€ã¨ã‚³ãƒ¡ãƒ³ãƒˆ

            ### âš ï¸ æ³¨æ„
            - ã“ã®ç’°å¢ƒã¯ **min-instances=0** ã§å‹•ä½œ (ã‚³ã‚¹ãƒˆå‰Šæ¸›)
            - åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã¯èµ·å‹•ã«æ•°ç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
            - ã“ã®ç’°å¢ƒã¯ Issue #${issueNumber} å°‚ç”¨ã§ã™

            ---
            *ğŸ¤– Automated preview deployment by GitHub Actions*`;

            await github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Cleanup preview environment when PR is closed
  cleanup-preview:
    name: Cleanup Preview Environment
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract issue number
        id: extract-info
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "Branch: $BRANCH_NAME"

          ISSUE_NUMBER=$(echo "$BRANCH_NAME" | grep -oP '(?<=issue-)\d+' || echo "")

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "âš ï¸ Could not extract issue number, skipping cleanup"
            exit 0
          fi

          SERVICE_NAME="ai-square-preview-issue-${ISSUE_NUMBER}"

          echo "issue-number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "service-name=$SERVICE_NAME" >> $GITHUB_OUTPUT

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Delete Cloud Run service
        run: |
          SERVICE_NAME="${{ steps.extract-info.outputs.service-name }}"
          ISSUE_NUMBER="${{ steps.extract-info.outputs.issue-number }}"

          echo "ğŸ§¹ Cleaning up preview environment for Issue #$ISSUE_NUMBER"

          # Check if service exists
          if gcloud run services describe "$SERVICE_NAME" --region ${{ env.REGION }} &>/dev/null; then
            gcloud run services delete "$SERVICE_NAME" \
              --region ${{ env.REGION }} \
              --quiet

            echo "âœ… Preview environment deleted: $SERVICE_NAME"
          else
            echo "â„¹ï¸ Service $SERVICE_NAME not found, nothing to clean up"
          fi

      - name: Comment on Issue about cleanup
        uses: actions/github-script@v7
        if: steps.extract-info.outputs.issue-number != ''
        with:
          script: |
            const issueNumber = ${{ steps.extract-info.outputs.issue-number }};
            const serviceName = '${{ steps.extract-info.outputs.service-name }}';

            const comment = `## ğŸ§¹ Preview Environment Cleaned Up

            Preview environment for Issue #${issueNumber} has been automatically deleted.

            - **Service**: \`${serviceName}\`
            - **Reason**: PR was closed/merged

            ---
            *ğŸ¤– Automated cleanup by GitHub Actions*`;

            await github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
