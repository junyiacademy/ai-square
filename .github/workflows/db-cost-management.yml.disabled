name: Database Cost Management

on:
  schedule:
    # æ¯å¤©æ™šä¸Š 10 é»è‡ªå‹•åœæ­¢è³‡æ–™åº«ï¼ˆUTC 14:00 = å°åŒ— 22:00ï¼‰
    - cron: '0 14 * * *'
  
  workflow_dispatch:
    inputs:
      action:
        description: 'Database action'
        required: true
        default: 'stop'
        type: choice
        options:
        - start
        - stop
        - status
        - cost-check

jobs:
  manage-database:
    name: Manage Cloud SQL Databases
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        version: 'latest'
    
    - name: Start Databases
      if: github.event.inputs.action == 'start'
      run: |
        echo "ğŸš€ Starting databases..."
        gcloud sql instances patch ai-square-db-staging-asia \
          --activation-policy=ALWAYS \
          --project=ai-square-463013
        echo "âœ… Staging DB started"
        
        # Production DB é€šå¸¸ä¸éœ€è¦è‡ªå‹•å•Ÿå‹•
        # gcloud sql instances patch ai-square-db-production \
        #   --activation-policy=ALWAYS \
        #   --project=ai-square-463013
    
    - name: Stop Databases (Scheduled or Manual)
      if: github.event_name == 'schedule' || github.event.inputs.action == 'stop'
      run: |
        echo "ğŸ›‘ Stopping all databases to save costs..."
        
        # Stop Staging DB
        gcloud sql instances patch ai-square-db-staging-asia \
          --activation-policy=NEVER \
          --project=ai-square-463013 || true
        echo "âœ… Staging DB stopped"
        
        # Stop Production DB
        gcloud sql instances patch ai-square-db-production \
          --activation-policy=NEVER \
          --project=ai-square-463013 || true
        echo "âœ… Production DB stopped"
        
        echo "ğŸ’° Monthly cost reduced to: $0"
    
    - name: Check Status
      if: github.event.inputs.action == 'status'
      run: |
        echo "ğŸ“Š Database Status:"
        gcloud sql instances list --project=ai-square-463013 \
          --format="table(name,databaseVersion,settings.tier,state)"
    
    - name: Cost Check
      if: github.event.inputs.action == 'cost-check'
      run: |
        echo "ğŸ’° Cost Analysis:"
        gcloud sql instances list --project=ai-square-463013 \
          --format="table(name,settings.tier,state)"
        
        echo ""
        echo "Estimated monthly cost:"
        echo "â€¢ STOPPED: $0/month"
        echo "â€¢ RUNNABLE (db-f1-micro): ~$15/month per instance"
        echo ""
        echo "ğŸ’¡ Use 'stop' action to reduce costs to $0"
    
    - name: Send Slack Notification (Optional)
      if: always() && (github.event_name == 'schedule' || github.event.inputs.action == 'stop')
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        if [ -n "$SLACK_WEBHOOK_URL" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"ğŸ›‘ AI Square databases have been stopped to save costs. Monthly savings: $85"}' \
            $SLACK_WEBHOOK_URL
        fi