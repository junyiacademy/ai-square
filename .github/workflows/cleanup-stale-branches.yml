name: Cleanup Stale Branches

on:
  schedule:
    # Run every Monday at 2 AM UTC (10 AM Taiwan time)
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      max_age_days:
        description: 'Maximum age in days for merged branches'
        required: false
        default: '30'
        type: string
      dry_run:
        description: 'Dry run mode (do not actually delete)'
        required: false
        default: 'false'
        type: boolean

env:
  MAX_AGE_DAYS: ${{ github.event.inputs.max_age_days || '30' }}
  DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}

jobs:
  cleanup-merged-branches:
    name: Cleanup Merged Feature Branches
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history

      - name: Find and cleanup merged branches
        id: cleanup
        uses: actions/github-script@v7
        with:
          script: |
            const maxAgeDays = parseInt('${{ env.MAX_AGE_DAYS }}');
            const dryRun = '${{ env.DRY_RUN }}' === 'true';

            console.log(`üîç Finding merged branches older than ${maxAgeDays} days...`);
            console.log(`Dry run: ${dryRun}`);

            // Get all branches
            const branches = await github.rest.repos.listBranches({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100,
              protected: false
            });

            const protectedBranches = ['main', 'staging', 'master', 'develop', 'development'];
            const now = new Date();
            const cutoffDate = new Date(now.getTime() - maxAgeDays * 24 * 60 * 60 * 1000);

            let deletedCount = 0;
            let keptCount = 0;
            const deletedList = [];
            const keptList = [];

            for (const branch of branches.data) {
              const branchName = branch.name;

              // Skip protected branches
              if (protectedBranches.includes(branchName)) {
                console.log(`üîí Protected branch, skipping: ${branchName}`);
                continue;
              }

              // Only process issue branches (fix/issue-*, feat/issue-*)
              if (!branchName.match(/^(fix|feat)\/issue-\d+$/)) {
                console.log(`‚è≠Ô∏è  Not an issue branch, skipping: ${branchName}`);
                continue;
              }

              try {
                // Get branch commit info
                const { data: branchData } = await github.rest.repos.getBranch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  branch: branchName
                });

                const lastCommitDate = new Date(branchData.commit.commit.committer.date);
                const ageDays = Math.floor((now - lastCommitDate) / (1000 * 60 * 60 * 24));

                // Check if branch is merged
                const { data: compareData } = await github.rest.repos.compareCommits({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  base: branchName,
                  head: 'staging'
                });

                const isMerged = compareData.ahead_by === 0;

                // Extract issue number
                const issueMatch = branchName.match(/issue-(\d+)/);
                const issueNumber = issueMatch ? issueMatch[1] : null;

                // Check if PR exists and is open
                let hasOpenPR = false;
                if (issueNumber) {
                  const prs = await github.rest.pulls.list({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    head: `${context.repo.owner}:${branchName}`,
                    state: 'open'
                  });
                  hasOpenPR = prs.data.length > 0;
                }

                // Decision logic
                let shouldDelete = false;
                let reason = '';

                if (hasOpenPR) {
                  reason = `Open PR exists`;
                  keptList.push(`- ${branchName} (${reason}, ${ageDays} days old)`);
                  keptCount++;
                  console.log(`‚úÖ Keeping: ${branchName} (${reason})`);
                  continue;
                }

                if (isMerged && lastCommitDate < cutoffDate) {
                  shouldDelete = true;
                  reason = `Merged and older than ${maxAgeDays} days (${ageDays} days)`;
                } else if (isMerged) {
                  reason = `Merged but recent (${ageDays} days old)`;
                } else if (lastCommitDate < cutoffDate) {
                  reason = `Not merged but inactive for ${ageDays} days`;
                  // Only delete merged branches, keep unmerged for manual review
                  keptList.push(`- ${branchName} (${reason} - keep for manual review)`);
                  keptCount++;
                  console.log(`‚úÖ Keeping for review: ${branchName} (${reason})`);
                  continue;
                } else {
                  reason = `Active (${ageDays} days old)`;
                }

                if (shouldDelete) {
                  console.log(`üóëÔ∏è  Will delete: ${branchName} (${reason})`);
                  deletedList.push(`- ${branchName} (${reason})`);

                  if (!dryRun) {
                    try {
                      await github.rest.git.deleteRef({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        ref: `heads/${branchName}`
                      });
                      console.log(`  ‚úÖ Deleted: ${branchName}`);
                      deletedCount++;
                    } catch (error) {
                      console.log(`  ‚ùå Failed to delete ${branchName}: ${error.message}`);
                    }
                  } else {
                    console.log(`  [DRY RUN] Would delete: ${branchName}`);
                    deletedCount++;
                  }
                } else {
                  console.log(`‚úÖ Keeping: ${branchName} (${reason})`);
                  keptList.push(`- ${branchName} (${reason})`);
                  keptCount++;
                }
              } catch (error) {
                console.log(`‚ö†Ô∏è  Error processing ${branchName}: ${error.message}`);
              }
            }

            console.log('\nüìä Summary:');
            console.log(`- Branches deleted: ${deletedCount}`);
            console.log(`- Branches kept: ${keptCount}`);

            core.setOutput('deleted_count', deletedCount);
            core.setOutput('kept_count', keptCount);
            core.setOutput('deleted_list', deletedList.join('\n'));
            core.setOutput('kept_list', keptList.join('\n'));

            return {
              deletedCount,
              keptCount,
              deletedList,
              keptList
            };

      - name: Create cleanup report
        if: steps.cleanup.outputs.deleted_count > 0 || steps.cleanup.outputs.kept_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const deletedCount = parseInt('${{ steps.cleanup.outputs.deleted_count }}');
            const keptCount = parseInt('${{ steps.cleanup.outputs.kept_count }}');
            const dryRun = '${{ env.DRY_RUN }}' === 'true';
            const deletedList = `${{ steps.cleanup.outputs.deleted_list }}`;
            const keptList = `${{ steps.cleanup.outputs.kept_list }}`;

            const actionText = dryRun ? 'Would delete' : 'Deleted';
            const emoji = dryRun ? 'üîç' : 'üßπ';

            let comment = `## ${emoji} Stale Branches Cleanup Report\n\n`;

            if (dryRun) {
              comment += `**Mode**: üîç Dry Run (no actual deletion)\n\n`;
            }

            comment += `### Summary\n\n`;
            comment += `- **Branches ${actionText.toLowerCase()}**: ${deletedCount}\n`;
            comment += `- **Branches kept**: ${keptCount}\n`;
            comment += `- **Max age for merged branches**: ${{ env.MAX_AGE_DAYS }} days\n\n`;

            if (deletedList.trim()) {
              comment += `### ${actionText} Branches\n\n${deletedList}\n\n`;
            }

            if (keptList.trim() && keptCount <= 20) {
              comment += `### ‚úÖ Kept Branches\n\n${keptList}\n\n`;
            } else if (keptCount > 20) {
              comment += `### ‚úÖ Kept Branches\n\n${keptCount} branches kept (too many to list)\n\n`;
            }

            comment += `### Cleanup Policy\n\n`;
            comment += `- ‚úÖ Auto-delete: Merged branches older than ${{ env.MAX_AGE_DAYS }} days\n`;
            comment += `- ‚è≠Ô∏è  Skip: Branches with open PRs\n`;
            comment += `- ‚è≠Ô∏è  Skip: Unmerged branches (kept for manual review)\n`;
            comment += `- üîí Protected: main, staging, master, develop\n\n`;

            comment += `\n---\n*ü§ñ Automated cleanup ‚Ä¢ Triggered: ${new Date().toISOString()}*`;

            // Find or create tracking issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['automated-cleanup', 'infrastructure'],
              state: 'open'
            });

            let trackingIssue = issues.data.find(i => i.title.includes('Stale Branches Cleanup'));

            if (!trackingIssue) {
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'üßπ Stale Branches Cleanup Tracking',
                body: 'This issue tracks automated stale branches cleanup operations.\n\nCleanup reports will be posted as comments below.',
                labels: ['automated-cleanup', 'infrastructure']
              });
              trackingIssue = newIssue.data;
            }

            await github.rest.issues.createComment({
              issue_number: trackingIssue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Summary
        run: |
          echo "## Stale Branches Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branches deleted**: ${{ steps.cleanup.outputs.deleted_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branches kept**: ${{ steps.cleanup.outputs.kept_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry run mode**: ${{ env.DRY_RUN }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Max age**: ${{ env.MAX_AGE_DAYS }} days" >> $GITHUB_STEP_SUMMARY
