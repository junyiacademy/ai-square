name: Cleanup Stale Branches

on:
  schedule:
    # Run every Monday at 2 AM UTC (10 AM Taiwan time)
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      max_age_days:
        description: 'Maximum age in days for merged branches'
        required: false
        default: '30'
        type: string
      dry_run:
        description: 'Dry run mode (do not actually delete)'
        required: false
        default: 'false'
        type: boolean

env:
  MAX_AGE_DAYS: ${{ github.event.inputs.max_age_days || '30' }}
  DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}

jobs:
  cleanup-merged-branches:
    name: Cleanup Merged Feature Branches
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history

      - name: Find and cleanup merged branches
        id: cleanup
        uses: actions/github-script@v7
        with:
          script: |
            const maxAgeDays = parseInt('${{ env.MAX_AGE_DAYS }}');
            const dryRun = '${{ env.DRY_RUN }}' === 'true';

            console.log(`ðŸ” Finding merged branches older than ${maxAgeDays} days...`);
            console.log(`Dry run: ${dryRun}`);

            // Get all branches
            const branches = await github.rest.repos.listBranches({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100,
              protected: false
            });

            const protectedBranches = ['main', 'staging', 'master', 'develop', 'development'];
            const now = new Date();
            const cutoffDate = new Date(now.getTime() - maxAgeDays * 24 * 60 * 60 * 1000);

            let deletedCount = 0;
            let keptCount = 0;
            const deletedList = [];
            const keptList = [];

            for (const branch of branches.data) {
              const branchName = branch.name;

              // Skip protected branches
              if (protectedBranches.includes(branchName)) {
                console.log(`ðŸ”’ Protected branch, skipping: ${branchName}`);
                continue;
              }

              // Only process issue branches (fix/issue-*, feat/issue-*)
              if (!branchName.match(/^(fix|feat)\/issue-\d+$/)) {
                console.log(`â­ï¸  Not an issue branch, skipping: ${branchName}`);
                continue;
              }

              try {
                // Get branch commit info
                const { data: branchData } = await github.rest.repos.getBranch({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  branch: branchName
                });

                const lastCommitDate = new Date(branchData.commit.commit.committer.date);
                const ageDays = Math.floor((now - lastCommitDate) / (1000 * 60 * 60 * 24));

                // Check if branch is merged
                const { data: compareData } = await github.rest.repos.compareCommits({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  base: branchName,
                  head: 'staging'
                });

                const isMerged = compareData.ahead_by === 0;

                // Extract issue number
                const issueMatch = branchName.match(/issue-(\d+)/);
                const issueNumber = issueMatch ? issueMatch[1] : null;

                // Check if PR exists and is open
                let hasOpenPR = false;
                if (issueNumber) {
                  const prs = await github.rest.pulls.list({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    head: `${context.repo.owner}:${branchName}`,
                    state: 'open'
                  });
                  hasOpenPR = prs.data.length > 0;
                }

                // Decision logic
                let shouldDelete = false;
                let reason = '';

                if (hasOpenPR) {
                  reason = `Open PR exists`;
                  keptList.push(`- ${branchName} (${reason}, ${ageDays} days old)`);
                  keptCount++;
                  console.log(`âœ… Keeping: ${branchName} (${reason})`);
                  continue;
                }

                if (isMerged && lastCommitDate < cutoffDate) {
                  shouldDelete = true;
                  reason = `Merged and older than ${maxAgeDays} days (${ageDays} days)`;
                } else if (isMerged) {
                  reason = `Merged but recent (${ageDays} days old)`;
                } else if (lastCommitDate < cutoffDate) {
                  reason = `Not merged but inactive for ${ageDays} days`;
                  // Only delete merged branches, keep unmerged for manual review
                  keptList.push(`- ${branchName} (${reason} - keep for manual review)`);
                  keptCount++;
                  console.log(`âœ… Keeping for review: ${branchName} (${reason})`);
                  continue;
                } else {
                  reason = `Active (${ageDays} days old)`;
                }

                if (shouldDelete) {
                  console.log(`ðŸ—‘ï¸  Will delete: ${branchName} (${reason})`);
                  deletedList.push(`- ${branchName} (${reason})`);

                  if (!dryRun) {
                    try {
                      await github.rest.git.deleteRef({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        ref: `heads/${branchName}`
                      });
                      console.log(`  âœ… Deleted: ${branchName}`);
                      deletedCount++;
                    } catch (error) {
                      console.log(`  âŒ Failed to delete ${branchName}: ${error.message}`);
                    }
                  } else {
                    console.log(`  [DRY RUN] Would delete: ${branchName}`);
                    deletedCount++;
                  }
                } else {
                  console.log(`âœ… Keeping: ${branchName} (${reason})`);
                  keptList.push(`- ${branchName} (${reason})`);
                  keptCount++;
                }
              } catch (error) {
                console.log(`âš ï¸  Error processing ${branchName}: ${error.message}`);
              }
            }

            console.log('\nðŸ“Š Summary:');
            console.log(`- Branches deleted: ${deletedCount}`);
            console.log(`- Branches kept: ${keptCount}`);

            core.setOutput('deleted_count', deletedCount);
            core.setOutput('kept_count', keptCount);
            core.setOutput('deleted_list', deletedList.join('\n'));
            core.setOutput('kept_list', keptList.join('\n'));

            return {
              deletedCount,
              keptCount,
              deletedList,
              keptList
            };

      - name: Log cleanup report
        if: steps.cleanup.outputs.deleted_count > 0 || steps.cleanup.outputs.kept_count > 0
        run: |
          echo "ðŸ§¹ Stale Branches Cleanup Report"
          echo ""
          echo "Deleted: ${{ steps.cleanup.outputs.deleted_count }}"
          echo "Kept: ${{ steps.cleanup.outputs.kept_count }}"
          echo "Max age: ${{ env.MAX_AGE_DAYS }} days"
          echo "Dry run: ${{ env.DRY_RUN }}"
          echo ""
          echo "See full details in GitHub Actions logs:"
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Summary
        run: |
          echo "## Stale Branches Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branches deleted**: ${{ steps.cleanup.outputs.deleted_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branches kept**: ${{ steps.cleanup.outputs.kept_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry run mode**: ${{ env.DRY_RUN }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Max age**: ${{ env.MAX_AGE_DAYS }} days" >> $GITHUB_STEP_SUMMARY
