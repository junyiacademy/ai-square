name: Cleanup GitHub Artifacts

on:
  schedule:
    # Run daily at 1 AM UTC (9 AM Taiwan time)
    - cron: '0 1 * * *'
  workflow_dispatch:
    inputs:
      max_age_days:
        description: 'Maximum age in days for artifacts'
        required: false
        default: '7'
        type: string
      keep_successful:
        description: 'Keep latest successful build artifacts'
        required: false
        default: 'true'
        type: boolean
      dry_run:
        description: 'Dry run mode (do not actually delete)'
        required: false
        default: 'false'
        type: boolean

env:
  MAX_AGE_DAYS: ${{ github.event.inputs.max_age_days || '7' }}
  KEEP_SUCCESSFUL: ${{ github.event.inputs.keep_successful || 'true' }}
  DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}

jobs:
  cleanup-artifacts:
    name: Cleanup Old GitHub Artifacts
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cleanup old artifacts
        id: cleanup
        uses: actions/github-script@v7
        with:
          script: |
            const maxAgeDays = parseInt('${{ env.MAX_AGE_DAYS }}');
            const keepSuccessful = '${{ env.KEEP_SUCCESSFUL }}' === 'true';
            const dryRun = '${{ env.DRY_RUN }}' === 'true';

            console.log(`ðŸ” Scanning for artifacts older than ${maxAgeDays} days...`);
            console.log(`Keep successful: ${keepSuccessful}`);
            console.log(`Dry run: ${dryRun}`);

            // Get all artifacts
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            const now = new Date();
            const cutoffDate = new Date(now.getTime() - maxAgeDays * 24 * 60 * 60 * 1000);

            let deletedCount = 0;
            let keptCount = 0;
            let spaceSavedMB = 0;
            const deletedList = [];
            const keptList = [];
            const successfulArtifacts = new Map();

            // First pass: identify latest successful artifacts
            if (keepSuccessful) {
              for (const artifact of artifacts.data.artifacts) {
                const workflowName = artifact.workflow_run?.head_branch || 'unknown';
                const key = `${artifact.name}-${workflowName}`;

                if (artifact.workflow_run?.conclusion === 'success') {
                  const existing = successfulArtifacts.get(key);
                  const artifactDate = new Date(artifact.created_at);

                  if (!existing || artifactDate > new Date(existing.created_at)) {
                    successfulArtifacts.set(key, artifact);
                  }
                }
              }

              console.log(`Found ${successfulArtifacts.size} latest successful artifacts to keep`);
            }

            // Second pass: delete old artifacts
            for (const artifact of artifacts.data.artifacts) {
              const artifactDate = new Date(artifact.created_at);
              const ageDays = Math.floor((now - artifactDate) / (1000 * 60 * 60 * 24));
              const sizeMB = Math.round(artifact.size_in_bytes / 1024 / 1024);

              // Check if this is a protected successful artifact
              const workflowName = artifact.workflow_run?.head_branch || 'unknown';
              const key = `${artifact.name}-${workflowName}`;
              const isLatestSuccessful = keepSuccessful &&
                successfulArtifacts.has(key) &&
                successfulArtifacts.get(key).id === artifact.id;

              if (isLatestSuccessful) {
                console.log(`âœ… Keeping latest successful: ${artifact.name} (${ageDays} days old, ${sizeMB}MB)`);
                keptList.push(`- ${artifact.name} (latest successful, ${ageDays} days old, ${sizeMB}MB)`);
                keptCount++;
                continue;
              }

              if (artifactDate < cutoffDate) {
                console.log(`ðŸ—‘ï¸  Will delete: ${artifact.name} (${ageDays} days old, ${sizeMB}MB)`);
                deletedList.push(`- ${artifact.name} (${ageDays} days old, ${sizeMB}MB)`);

                if (!dryRun) {
                  try {
                    await github.rest.actions.deleteArtifact({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      artifact_id: artifact.id
                    });
                    console.log(`  âœ… Deleted: ${artifact.name}`);
                    deletedCount++;
                    spaceSavedMB += sizeMB;
                  } catch (error) {
                    console.log(`  âŒ Failed to delete ${artifact.name}: ${error.message}`);
                  }
                } else {
                  console.log(`  [DRY RUN] Would delete: ${artifact.name}`);
                  deletedCount++;
                  spaceSavedMB += sizeMB;
                }
              } else {
                console.log(`âœ… Keeping recent: ${artifact.name} (${ageDays} days old, ${sizeMB}MB)`);
                keptList.push(`- ${artifact.name} (${ageDays} days old, ${sizeMB}MB)`);
                keptCount++;
              }
            }

            console.log('\nðŸ“Š Summary:');
            console.log(`- Artifacts deleted: ${deletedCount}`);
            console.log(`- Artifacts kept: ${keptCount}`);
            console.log(`- Space saved: ~${spaceSavedMB}MB`);

            core.setOutput('deleted_count', deletedCount);
            core.setOutput('kept_count', keptCount);
            core.setOutput('space_saved_mb', spaceSavedMB);
            core.setOutput('deleted_list', deletedList.join('\n'));
            core.setOutput('kept_list', keptList.join('\n'));

            return {
              deletedCount,
              keptCount,
              spaceSavedMB,
              deletedList,
              keptList
            };

      - name: Log cleanup report
        if: steps.cleanup.outputs.deleted_count > 0
        run: |
          echo "ðŸ§¹ GitHub Artifacts Cleanup Report"
          echo ""
          echo "Deleted: ${{ steps.cleanup.outputs.deleted_count }}"
          echo "Kept: ${{ steps.cleanup.outputs.kept_count }}"
          echo "Space saved: ~${{ steps.cleanup.outputs.space_saved_mb }}MB"
          echo "Max age: ${{ env.MAX_AGE_DAYS }} days"
          echo "Keep successful: ${{ env.KEEP_SUCCESSFUL }}"
          echo "Dry run: ${{ env.DRY_RUN }}"
          echo ""
          echo "See full details in GitHub Actions logs:"
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Summary
        run: |
          echo "## GitHub Artifacts Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts deleted**: ${{ steps.cleanup.outputs.deleted_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts kept**: ${{ steps.cleanup.outputs.kept_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Space saved**: ~${{ steps.cleanup.outputs.space_saved_mb }}MB" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry run mode**: ${{ env.DRY_RUN }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Max age**: ${{ env.MAX_AGE_DAYS }} days" >> $GITHUB_STEP_SUMMARY
