name: Cleanup GitHub Artifacts

on:
  schedule:
    # Run daily at 1 AM UTC (9 AM Taiwan time)
    - cron: '0 1 * * *'
  workflow_dispatch:
    inputs:
      max_age_days:
        description: 'Maximum age in days for artifacts'
        required: false
        default: '7'
        type: string
      keep_successful:
        description: 'Keep latest successful build artifacts'
        required: false
        default: 'true'
        type: boolean
      dry_run:
        description: 'Dry run mode (do not actually delete)'
        required: false
        default: 'false'
        type: boolean

env:
  MAX_AGE_DAYS: ${{ github.event.inputs.max_age_days || '7' }}
  KEEP_SUCCESSFUL: ${{ github.event.inputs.keep_successful || 'true' }}
  DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}

jobs:
  cleanup-artifacts:
    name: Cleanup Old GitHub Artifacts
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cleanup old artifacts
        id: cleanup
        uses: actions/github-script@v7
        with:
          script: |
            const maxAgeDays = parseInt('${{ env.MAX_AGE_DAYS }}');
            const keepSuccessful = '${{ env.KEEP_SUCCESSFUL }}' === 'true';
            const dryRun = '${{ env.DRY_RUN }}' === 'true';

            console.log(`üîç Scanning for artifacts older than ${maxAgeDays} days...`);
            console.log(`Keep successful: ${keepSuccessful}`);
            console.log(`Dry run: ${dryRun}`);

            // Get all artifacts
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            const now = new Date();
            const cutoffDate = new Date(now.getTime() - maxAgeDays * 24 * 60 * 60 * 1000);

            let deletedCount = 0;
            let keptCount = 0;
            let spaceSavedMB = 0;
            const deletedList = [];
            const keptList = [];
            const successfulArtifacts = new Map();

            // First pass: identify latest successful artifacts
            if (keepSuccessful) {
              for (const artifact of artifacts.data.artifacts) {
                const workflowName = artifact.workflow_run?.head_branch || 'unknown';
                const key = `${artifact.name}-${workflowName}`;

                if (artifact.workflow_run?.conclusion === 'success') {
                  const existing = successfulArtifacts.get(key);
                  const artifactDate = new Date(artifact.created_at);

                  if (!existing || artifactDate > new Date(existing.created_at)) {
                    successfulArtifacts.set(key, artifact);
                  }
                }
              }

              console.log(`Found ${successfulArtifacts.size} latest successful artifacts to keep`);
            }

            // Second pass: delete old artifacts
            for (const artifact of artifacts.data.artifacts) {
              const artifactDate = new Date(artifact.created_at);
              const ageDays = Math.floor((now - artifactDate) / (1000 * 60 * 60 * 24));
              const sizeMB = Math.round(artifact.size_in_bytes / 1024 / 1024);

              // Check if this is a protected successful artifact
              const workflowName = artifact.workflow_run?.head_branch || 'unknown';
              const key = `${artifact.name}-${workflowName}`;
              const isLatestSuccessful = keepSuccessful &&
                successfulArtifacts.has(key) &&
                successfulArtifacts.get(key).id === artifact.id;

              if (isLatestSuccessful) {
                console.log(`‚úÖ Keeping latest successful: ${artifact.name} (${ageDays} days old, ${sizeMB}MB)`);
                keptList.push(`- ${artifact.name} (latest successful, ${ageDays} days old, ${sizeMB}MB)`);
                keptCount++;
                continue;
              }

              if (artifactDate < cutoffDate) {
                console.log(`üóëÔ∏è  Will delete: ${artifact.name} (${ageDays} days old, ${sizeMB}MB)`);
                deletedList.push(`- ${artifact.name} (${ageDays} days old, ${sizeMB}MB)`);

                if (!dryRun) {
                  try {
                    await github.rest.actions.deleteArtifact({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      artifact_id: artifact.id
                    });
                    console.log(`  ‚úÖ Deleted: ${artifact.name}`);
                    deletedCount++;
                    spaceSavedMB += sizeMB;
                  } catch (error) {
                    console.log(`  ‚ùå Failed to delete ${artifact.name}: ${error.message}`);
                  }
                } else {
                  console.log(`  [DRY RUN] Would delete: ${artifact.name}`);
                  deletedCount++;
                  spaceSavedMB += sizeMB;
                }
              } else {
                console.log(`‚úÖ Keeping recent: ${artifact.name} (${ageDays} days old, ${sizeMB}MB)`);
                keptList.push(`- ${artifact.name} (${ageDays} days old, ${sizeMB}MB)`);
                keptCount++;
              }
            }

            console.log('\nüìä Summary:');
            console.log(`- Artifacts deleted: ${deletedCount}`);
            console.log(`- Artifacts kept: ${keptCount}`);
            console.log(`- Space saved: ~${spaceSavedMB}MB`);

            core.setOutput('deleted_count', deletedCount);
            core.setOutput('kept_count', keptCount);
            core.setOutput('space_saved_mb', spaceSavedMB);
            core.setOutput('deleted_list', deletedList.join('\n'));
            core.setOutput('kept_list', keptList.join('\n'));

            return {
              deletedCount,
              keptCount,
              spaceSavedMB,
              deletedList,
              keptList
            };

      - name: Create cleanup report
        if: steps.cleanup.outputs.deleted_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const deletedCount = parseInt('${{ steps.cleanup.outputs.deleted_count }}');
            const keptCount = parseInt('${{ steps.cleanup.outputs.kept_count }}');
            const spaceSaved = parseInt('${{ steps.cleanup.outputs.space_saved_mb }}');
            const dryRun = '${{ env.DRY_RUN }}' === 'true';
            const deletedList = `${{ steps.cleanup.outputs.deleted_list }}`;
            const keptList = `${{ steps.cleanup.outputs.kept_list }}`;

            const actionText = dryRun ? 'Would delete' : 'Deleted';
            const emoji = dryRun ? 'üîç' : 'üßπ';

            let comment = `## ${emoji} GitHub Artifacts Cleanup Report\n\n`;

            if (dryRun) {
              comment += `**Mode**: üîç Dry Run (no actual deletion)\n\n`;
            }

            comment += `### Summary\n\n`;
            comment += `- **Artifacts ${actionText.toLowerCase()}**: ${deletedCount}\n`;
            comment += `- **Artifacts kept**: ${keptCount}\n`;
            comment += `- **Space saved**: ~${spaceSaved}MB\n`;
            comment += `- **Max age**: ${{ env.MAX_AGE_DAYS }} days\n`;
            comment += `- **Keep successful**: ${{ env.KEEP_SUCCESSFUL }}\n\n`;

            if (deletedList.trim()) {
              comment += `### ${actionText} Artifacts\n\n${deletedList}\n\n`;
            }

            if (keptList.trim() && keptCount <= 20) {
              comment += `### ‚úÖ Kept Artifacts\n\n${keptList}\n\n`;
            } else if (keptCount > 20) {
              comment += `### ‚úÖ Kept Artifacts\n\n${keptCount} artifacts kept (too many to list)\n\n`;
            }

            comment += `\n---\n*ü§ñ Automated cleanup ‚Ä¢ Triggered: ${new Date().toISOString()}*`;

            // Find or create tracking issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['automated-cleanup', 'infrastructure'],
              state: 'open'
            });

            let trackingIssue = issues.data.find(i => i.title.includes('GitHub Artifacts Cleanup'));

            if (!trackingIssue) {
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'üßπ GitHub Artifacts Cleanup Tracking',
                body: 'This issue tracks automated GitHub artifacts cleanup operations.\n\nCleanup reports will be posted as comments below.',
                labels: ['automated-cleanup', 'infrastructure']
              });
              trackingIssue = newIssue.data;
            }

            await github.rest.issues.createComment({
              issue_number: trackingIssue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Summary
        run: |
          echo "## GitHub Artifacts Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts deleted**: ${{ steps.cleanup.outputs.deleted_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts kept**: ${{ steps.cleanup.outputs.kept_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Space saved**: ~${{ steps.cleanup.outputs.space_saved_mb }}MB" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry run mode**: ${{ env.DRY_RUN }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Max age**: ${{ env.MAX_AGE_DAYS }} days" >> $GITHUB_STEP_SUMMARY
