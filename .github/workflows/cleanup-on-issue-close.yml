name: Cleanup on Issue Close

on:
  issues:
    types: [closed]

env:
  PROJECT_ID: ai-square-463013
  REGION: asia-east1

jobs:
  cleanup-preview-on-issue-close:
    name: Delete Preview Environment
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Extract issue number
        id: issue
        run: |
          echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          echo "ðŸ“ Issue #${{ github.event.issue.number }} was closed"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Delete preview service
        id: delete
        continue-on-error: true
        run: |
          SERVICE_NAME="ai-square-preview-issue-${{ steps.issue.outputs.number }}"
          echo "ðŸ” Attempting to delete: $SERVICE_NAME"

          # Check if service exists
          if gcloud run services describe "$SERVICE_NAME" \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} &>/dev/null; then

            echo "ðŸ—‘ï¸  Service found, deleting..."
            gcloud run services delete "$SERVICE_NAME" \
              --region=${{ env.REGION }} \
              --project=${{ env.PROJECT_ID }} \
              --quiet

            echo "deleted=true" >> $GITHUB_OUTPUT
            echo "service_name=$SERVICE_NAME" >> $GITHUB_OUTPUT
            echo "âœ… Successfully deleted: $SERVICE_NAME"
          else
            echo "â„¹ï¸  Service not found (already deleted or never created)"
            echo "deleted=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on issue
        if: steps.delete.outputs.deleted == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const serviceName = '${{ steps.delete.outputs.service_name }}';
            const issueNumber = ${{ steps.issue.outputs.number }};

            const comment = `## ðŸ§¹ Preview Environment Cleaned Up

            Preview environment automatically deleted when issue was closed.

            ### Details
            - **Service**: \`${serviceName}\`
            - **Trigger**: Issue #${issueNumber} closed
            - **Status**: âœ… Deleted successfully

            ---
            *ðŸ¤– Automated cleanup triggered by issue close*`;

            await github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
