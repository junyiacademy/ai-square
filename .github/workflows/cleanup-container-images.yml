name: Cleanup Container Images

on:
  schedule:
    # Run every Sunday at 3 AM UTC (11 AM Taiwan time)
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      max_age_days:
        description: 'Maximum age in days for untagged images'
        required: false
        default: '30'
        type: string
      keep_versions:
        description: 'Number of recent versions to keep per service'
        required: false
        default: '10'
        type: string
      dry_run:
        description: 'Dry run mode (do not actually delete)'
        required: false
        default: 'false'
        type: boolean

env:
  PROJECT_ID: ai-square-463013
  MAX_AGE_DAYS: ${{ github.event.inputs.max_age_days || '30' }}
  KEEP_VERSIONS: ${{ github.event.inputs.keep_versions || '10' }}
  DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}

jobs:
  cleanup-gcr-images:
    name: Cleanup GCR Container Images
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Cleanup old preview images
        id: cleanup_preview
        run: |
          echo "üîç Finding old preview container images..."

          # Get all preview image repositories
          REPOS=$(gcloud container images list \
            --repository=gcr.io/${{ env.PROJECT_ID }} \
            --filter="name~ai-square-preview-issue-" \
            --format="value(name)" || echo "")

          if [ -z "$REPOS" ]; then
            echo "No preview image repositories found"
            echo "deleted_count=0" >> $GITHUB_OUTPUT
            echo "space_saved_mb=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found preview repositories:"
          echo "$REPOS"

          TOTAL_DELETED=0
          TOTAL_SIZE_MB=0
          DELETED_IMAGES=""

          while IFS= read -r repo; do
            if [ -z "$repo" ]; then
              continue
            fi

            echo ""
            echo "üì¶ Processing repository: $repo"

            # Get all digests sorted by creation time (newest first)
            DIGESTS=$(gcloud container images list-tags "$repo" \
              --format='get(digest,timestamp.datetime)' \
              --sort-by=~timestamp \
              --limit=1000 || echo "")

            if [ -z "$DIGESTS" ]; then
              echo "  No images found in $repo"
              continue
            fi

            # Count total images in this repo
            TOTAL_IMAGES=$(echo "$DIGESTS" | wc -l)
            echo "  Total images in repo: $TOTAL_IMAGES"

            # Skip protected tags (production, staging)
            PROTECTED_TAGS=$(gcloud container images list-tags "$repo" \
              --filter="tags:production OR tags:staging OR tags:latest" \
              --format="value(digest)" || echo "")

            KEPT_COUNT=0
            DELETED_IN_REPO=0

            echo "$DIGESTS" | while IFS=$'\t' read -r digest timestamp; do
              if [ -z "$digest" ]; then
                continue
              fi

              # Check if this is a protected tag
              IS_PROTECTED=false
              if echo "$PROTECTED_TAGS" | grep -q "$digest"; then
                IS_PROTECTED=true
              fi

              # Keep the first N versions (most recent)
              if [ $KEPT_COUNT -lt ${{ env.KEEP_VERSIONS }} ]; then
                if [ "$IS_PROTECTED" = false ]; then
                  echo "  ‚úÖ Keeping recent version: ${digest:0:12}... (timestamp: $timestamp)"
                  KEPT_COUNT=$((KEPT_COUNT + 1))
                  continue
                fi
              fi

              # Check age for deletion
              if [ -n "$timestamp" ]; then
                CURRENT_TIME=$(date +%s)
                IMAGE_TIME=$(date -d "$timestamp" +%s 2>/dev/null || date -jf "%Y-%m-%dT%H:%M:%S" "$timestamp" +%s 2>/dev/null || echo "0")

                if [ "$IMAGE_TIME" != "0" ]; then
                  DAYS_OLD=$(( ($CURRENT_TIME - $IMAGE_TIME) / 86400 ))

                  if [ $DAYS_OLD -lt ${{ env.MAX_AGE_DAYS }} ]; then
                    echo "  ‚úÖ Keeping recent image: ${digest:0:12}... (age: ${DAYS_OLD} days)"
                    KEPT_COUNT=$((KEPT_COUNT + 1))
                    continue
                  fi
                fi
              fi

              # Protected images are never deleted
              if [ "$IS_PROTECTED" = true ]; then
                echo "  üîí Protected tag, keeping: ${digest:0:12}..."
                continue
              fi

              # Delete this image
              IMAGE_URI="${repo}@${digest}"
              echo "  üóëÔ∏è  Deleting old image: ${digest:0:12}... (age: ${DAYS_OLD:-unknown} days)"

              if [ "${{ env.DRY_RUN }}" = "false" ]; then
                # Get image size before deletion
                SIZE_BYTES=$(gcloud container images describe "$IMAGE_URI" \
                  --format='value(image_summary.digest,image_summary.fully_qualified_digest)' 2>/dev/null | wc -c || echo "0")
                SIZE_MB=$((SIZE_BYTES / 1024 / 1024))

                if gcloud container images delete "$IMAGE_URI" --quiet 2>/dev/null; then
                  echo "    ‚úÖ Deleted: ${digest:0:12}..."
                  DELETED_IN_REPO=$((DELETED_IN_REPO + 1))
                  TOTAL_SIZE_MB=$((TOTAL_SIZE_MB + SIZE_MB))
                  DELETED_IMAGES="${DELETED_IMAGES}- ${repo}@${digest:0:12}... (${DAYS_OLD:-unknown} days old, ~${SIZE_MB}MB)\n"
                else
                  echo "    ‚ùå Failed to delete: ${digest:0:12}..."
                fi
              else
                echo "    [DRY RUN] Would delete: ${digest:0:12}..."
                DELETED_IN_REPO=$((DELETED_IN_REPO + 1))
                DELETED_IMAGES="${DELETED_IMAGES}- ${repo}@${digest:0:12}... (${DAYS_OLD:-unknown} days old)\n"
              fi
            done

            TOTAL_DELETED=$((TOTAL_DELETED + DELETED_IN_REPO))
            echo "  Deleted $DELETED_IN_REPO images from $repo"
          done <<< "$REPOS"

          echo ""
          echo "üìä Summary:"
          echo "- Total images deleted: $TOTAL_DELETED"
          echo "- Space saved: ~${TOTAL_SIZE_MB}MB"
          echo "- Dry run mode: ${{ env.DRY_RUN }}"

          echo "deleted_count=$TOTAL_DELETED" >> $GITHUB_OUTPUT
          echo "space_saved_mb=$TOTAL_SIZE_MB" >> $GITHUB_OUTPUT
          echo "deleted_images<<EOF" >> $GITHUB_OUTPUT
          echo -e "$DELETED_IMAGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Cleanup untagged images
        id: cleanup_untagged
        run: |
          echo "üîç Finding untagged images..."

          # Find all repositories
          ALL_REPOS=$(gcloud container images list \
            --repository=gcr.io/${{ env.PROJECT_ID }} \
            --format="value(name)" || echo "")

          UNTAGGED_DELETED=0
          UNTAGGED_SIZE_MB=0

          while IFS= read -r repo; do
            if [ -z "$repo" ]; then
              continue
            fi

            # Find untagged images (no tags, only digest)
            UNTAGGED=$(gcloud container images list-tags "$repo" \
              --filter='-tags:*' \
              --format='value(digest,timestamp.datetime)' \
              --limit=1000 || echo "")

            if [ -z "$UNTAGGED" ]; then
              continue
            fi

            echo "Found untagged images in $repo"

            echo "$UNTAGGED" | while IFS=$'\t' read -r digest timestamp; do
              if [ -z "$digest" ]; then
                continue
              fi

              # Check age
              if [ -n "$timestamp" ]; then
                CURRENT_TIME=$(date +%s)
                IMAGE_TIME=$(date -d "$timestamp" +%s 2>/dev/null || date -jf "%Y-%m-%dT%H:%M:%S" "$timestamp" +%s 2>/dev/null || echo "0")

                if [ "$IMAGE_TIME" != "0" ]; then
                  DAYS_OLD=$(( ($CURRENT_TIME - $IMAGE_TIME) / 86400 ))

                  # Only delete untagged images older than 7 days
                  if [ $DAYS_OLD -lt 7 ]; then
                    continue
                  fi

                  IMAGE_URI="${repo}@${digest}"
                  echo "  üóëÔ∏è  Deleting untagged image: ${digest:0:12}... (age: ${DAYS_OLD} days)"

                  if [ "${{ env.DRY_RUN }}" = "false" ]; then
                    if gcloud container images delete "$IMAGE_URI" --quiet 2>/dev/null; then
                      UNTAGGED_DELETED=$((UNTAGGED_DELETED + 1))
                    fi
                  else
                    echo "    [DRY RUN] Would delete untagged: ${digest:0:12}..."
                    UNTAGGED_DELETED=$((UNTAGGED_DELETED + 1))
                  fi
                fi
              fi
            done
          done <<< "$ALL_REPOS"

          echo "untagged_deleted=$UNTAGGED_DELETED" >> $GITHUB_OUTPUT

      - name: Log cleanup report
        if: steps.cleanup_preview.outputs.deleted_count > 0 || steps.cleanup_untagged.outputs.untagged_deleted > 0
        run: |
          echo "üßπ Container Images Cleanup Report"
          echo ""
          echo "Preview images deleted: ${{ steps.cleanup_preview.outputs.deleted_count }}"
          echo "Untagged images deleted: ${{ steps.cleanup_untagged.outputs.untagged_deleted }}"
          echo "Space saved: ~${{ steps.cleanup_preview.outputs.space_saved_mb }}MB"
          echo "Keep versions: ${{ env.KEEP_VERSIONS }}"
          echo "Max age: ${{ env.MAX_AGE_DAYS }} days"
          echo "Dry run: ${{ env.DRY_RUN }}"
          echo ""
          echo "See full details in GitHub Actions logs:"
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Summary
        run: |
          echo "## Container Images Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Preview images deleted**: ${{ steps.cleanup_preview.outputs.deleted_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Untagged images deleted**: ${{ steps.cleanup_untagged.outputs.untagged_deleted }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Space saved**: ~${{ steps.cleanup_preview.outputs.space_saved_mb }}MB" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry run mode**: ${{ env.DRY_RUN }}" >> $GITHUB_STEP_SUMMARY
