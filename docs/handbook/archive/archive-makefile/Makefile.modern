# ç¾ä»£åŒ– AI é–‹ç™¼æµç¨‹ - æ¥µç°¡ç‰ˆ
# å°ˆæ³¨æ–¼æ•ˆç‡å’Œ AI å‹å–„çš„è¨­è¨ˆ

.PHONY: new save done fix review help

# é è¨­é¡¯ç¤ºå¹«åŠ©
.DEFAULT_GOAL := help

# é¡è‰²å®šç¾©
GREEN := \033[0;32m
YELLOW := \033[0;33m
BLUE := \033[0;34m
RED := \033[0;31m
NC := \033[0m

#=============================================================================
# æ ¸å¿ƒå‘½ä»¤ï¼ˆè¦†è“‹ 80% ä½¿ç”¨å ´æ™¯ï¼‰
#=============================================================================

## é–‹å§‹æ–°å·¥ä½œï¼ˆè‡ªå‹•å‰µå»ºç¥¨åˆ¸ã€åˆ†æ”¯ã€è¨˜éŒ„ AI ä½¿ç”¨ï¼‰
new:
	@echo "$(GREEN)ğŸš€ é–‹å§‹æ–°å·¥ä½œ: $(TICKET)$(NC)"
	@python3 docs/scripts/ticket-driven-dev.py create \
		--type=$(TYPE) \
		--name=$(TICKET) \
		--auto-branch
	@echo "$(BLUE)ğŸ“Š AI æŒ‡æ¨™è¿½è¹¤å·²å•Ÿå‹•$(NC)"

## æ™ºèƒ½ä¿å­˜é€²åº¦ï¼ˆè‡ªå‹• checkpoint + AI åˆ†æ + è¨˜éŒ„ tokensï¼‰
save:
	@echo "$(YELLOW)ğŸ’¾ æ™ºèƒ½ä¿å­˜é€²åº¦...$(NC)"
	@# è‡ªå‹•åˆ†æè®Šæ›´
	@git diff --stat
	@# è¨˜éŒ„ AI ä½¿ç”¨ï¼ˆå¦‚æœæœ‰ï¼‰
	@python3 docs/scripts/ai-metrics-tracker.py track \
		--model=claude-3-opus \
		--prompt-tokens=$${PROMPT_TOKENS:-0} \
		--completion-tokens=$${COMPLETION_TOKENS:-0}
	@# Checkpoint
	@git add -A
	@git commit -m "checkpoint: $(shell date +%Y%m%d-%H%M%S)" || true
	@echo "$(GREEN)âœ… é€²åº¦å·²ä¿å­˜$(NC)"

## å®Œæˆå·¥ä½œï¼ˆæ¸¬è©¦ + æ™ºèƒ½æäº¤ + åˆä½µï¼‰
done:
	@echo "$(GREEN)ğŸ å®Œæˆå·¥ä½œæµç¨‹$(NC)"
	@# åŸ·è¡Œæ¸¬è©¦
	@make -s test-smart
	@# æ™ºèƒ½æäº¤
	@python3 docs/scripts/smart-commit.py
	@# ç”Ÿæˆ AI ä½¿ç”¨å ±å‘Š
	@python3 docs/scripts/ai-metrics-tracker.py report
	@# åˆä½µåˆ°ä¸»åˆ†æ”¯
	@git checkout main && git merge --no-ff ticket/$(TICKET)
	@echo "$(GREEN)âœ… å·¥ä½œå®Œæˆï¼$(NC)"

#=============================================================================
# AI è¼”åŠ©å‘½ä»¤ï¼ˆ20% ç‰¹æ®Šå ´æ™¯ï¼‰
#=============================================================================

## AI è‡ªå‹•ä¿®å¾©å•é¡Œ
fix:
	@echo "$(YELLOW)ğŸ”§ AI è‡ªå‹•ä¿®å¾©æ¨¡å¼$(NC)"
	@# æ”¶é›†éŒ¯èª¤ä¿¡æ¯
	@make test-smart > /tmp/test-errors.log 2>&1 || true
	@# è®“ AI åˆ†æä¸¦ä¿®å¾©
	@echo "åˆ†ææ¸¬è©¦éŒ¯èª¤ä¸¦æä¾›ä¿®å¾©å»ºè­°..."
	@cat /tmp/test-errors.log | tail -20
	@echo "$(BLUE)ğŸ’¡ æç¤º: ä½¿ç”¨ 'make save' ä¿å­˜ AI çš„ä¿®å¾©$(NC)"

## AI Code Review
review:
	@echo "$(BLUE)ğŸ” AI Code Review$(NC)"
	@git diff --cached > /tmp/review.diff
	@echo "è®Šæ›´æ‘˜è¦:"
	@git diff --cached --stat
	@echo "$(BLUE)ğŸ’¡ AI æ­£åœ¨åˆ†æç¨‹å¼ç¢¼å“è³ª...$(NC)"

#=============================================================================
# æ™ºèƒ½æ¸¬è©¦ï¼ˆè‡ªå‹•é¸æ“‡ç›¸é—œæ¸¬è©¦ï¼‰
#=============================================================================

test-smart:
	@echo "$(YELLOW)ğŸ§ª æ™ºèƒ½æ¸¬è©¦æ¨¡å¼$(NC)"
	@# åµæ¸¬è®Šæ›´çš„æª”æ¡ˆ
	@changed_files=$$(git diff --name-only HEAD~1..HEAD | grep -E '\.(ts|tsx|js|jsx)$$' || true); \
	if [ -n "$$changed_files" ]; then \
		echo "åµæ¸¬åˆ°è®Šæ›´ï¼ŒåŸ·è¡Œç›¸é—œæ¸¬è©¦..."; \
		cd frontend && npm test -- --findRelatedTests $$changed_files || true; \
	else \
		echo "åŸ·è¡ŒåŸºç¤æ¸¬è©¦å¥—ä»¶..."; \
		cd frontend && npm test -- --coverage=false || true; \
	fi

#=============================================================================
# æ•ˆç‡å ±å‘Š
#=============================================================================

## é¡¯ç¤º AI ä½¿ç”¨æ•ˆç‡å ±å‘Š
report:
	@echo "$(BLUE)ğŸ“Š AI é–‹ç™¼æ•ˆç‡å ±å‘Š$(NC)"
	@python3 docs/scripts/analytics.py efficiency --period=week
	@echo ""
	@python3 docs/scripts/ai-metrics-tracker.py report

#=============================================================================
# å¹«åŠ©
#=============================================================================

help:
	@echo "$(GREEN)ğŸš€ ç¾ä»£åŒ– AI é–‹ç™¼æµç¨‹$(NC)"
	@echo ""
	@echo "$(YELLOW)æ ¸å¿ƒå‘½ä»¤ï¼ˆ80% å ´æ™¯ï¼‰:$(NC)"
	@echo "  $(GREEN)make new$(NC) TYPE=feature TICKET=name  - é–‹å§‹æ–°å·¥ä½œ"
	@echo "  $(GREEN)make save$(NC)                          - æ™ºèƒ½ä¿å­˜é€²åº¦"  
	@echo "  $(GREEN)make done$(NC)                          - å®Œæˆå·¥ä½œ"
	@echo ""
	@echo "$(YELLOW)AI è¼”åŠ©ï¼ˆ20% å ´æ™¯ï¼‰:$(NC)"
	@echo "  $(GREEN)make fix$(NC)                           - AI è‡ªå‹•ä¿®å¾©"
	@echo "  $(GREEN)make review$(NC)                        - AI Code Review"
	@echo "  $(GREEN)make report$(NC)                        - æ•ˆç‡å ±å‘Š"
	@echo ""
	@echo "$(BLUE)ğŸ’¡ ç’°å¢ƒè®Šæ•¸:$(NC)"
	@echo "  PROMPT_TOKENS=1500                  - è¨˜éŒ„ prompt tokens"
	@echo "  COMPLETION_TOKENS=3000              - è¨˜éŒ„ completion tokens"

#=============================================================================
# AI å°ˆç”¨é…ç½®
#=============================================================================

# æ¸›å°‘è¼¸å‡ºé›œè¨Šï¼Œè®“ AI æ›´å®¹æ˜“è§£æ
export MAKEFLAGS += --no-print-directory --silent

# è‡ªå‹•è¨˜éŒ„åŸ·è¡Œæ™‚é–“
export TIME_START := $(shell date +%s)

# çµæŸæ™‚é¡¯ç¤ºåŸ·è¡Œæ™‚é–“
.ONESHELL:
SHELL = /bin/bash
.SHELLFLAGS = -ec