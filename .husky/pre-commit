#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Prisma Schema Consistency Check (Official Best Practice)
echo "🔍 Checking Prisma schema consistency..."
cd frontend

# 1. Prisma Schema Validation
echo "📝 Validating Prisma schema..."
DATABASE_URL="postgresql://postgres:postgres@localhost:5433/ai_square_db" npx prisma validate
if [ $? -ne 0 ]; then
  echo "❌ Prisma schema validation failed!"
  exit 1
fi

# 2. Check Migration Status
echo "📊 Checking migration status..."
DATABASE_URL="postgresql://postgres:postgres@localhost:5433/ai_square_db" npx prisma migrate status 2>&1 | grep -q "Database schema is up to date"
if [ $? -ne 0 ]; then
  echo "⚠️  Warning: Database may have pending migrations or drift"
  echo "💡 Run 'npm run prisma:drift' to check for schema drift"
fi

# 3. Custom TypeScript vs Prisma check (optional)
echo "🔷 Checking TypeScript types consistency..."
npx tsx scripts/validate-schema-consistency.ts
if [ $? -ne 0 ]; then
  echo "❌ Schema validation failed! Please fix the inconsistencies before committing."
  echo "💡 Tip: Make sure Prisma schema, TypeScript types, and database are in sync."
  exit 1
fi

# TypeScript Check
echo "📝 Running TypeScript check..."
npm run typecheck

if [ $? -ne 0 ]; then
  echo "❌ TypeScript errors found! Please fix them before committing."
  exit 1
fi

# ESLint Check
echo "🎨 Running ESLint..."
npm run lint

if [ $? -ne 0 ]; then
  echo "❌ ESLint errors found! Please fix them before committing."
  exit 1
fi

echo "✅ All pre-commit checks passed!"