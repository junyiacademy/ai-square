#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

cd frontend

# ===========================================
# Pre-commit Hook - Fast Local Validation
# Goal: Quick quality checks (< 5 seconds)
# ===========================================

echo "ğŸš€ Running pre-commit checks (fast)..."

# 1. Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' | sed 's|^frontend/||' | tr '\n' ' ')

if [ -z "$STAGED_FILES" ]; then
  echo "ğŸ“­ No TypeScript/JavaScript files to check"
  exit 0
fi

echo "ğŸ“ Checking $(echo $STAGED_FILES | wc -w | tr -d ' ') staged files..."

# 2. Run TypeScript check on staged files only
# Note: TypeScript can't check single files properly, so we check the whole project
# but only if TypeScript files are staged
echo "ğŸ” TypeScript check..."
npm run typecheck > /dev/null 2>&1
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript errors found in project"
  echo "ğŸ’¡ Run 'npm run typecheck' to see all errors"
  exit 1
fi

# 3. Run ESLint on staged files only
echo "ğŸ“‹ ESLint check (staged files)..."
npx eslint $STAGED_FILES --quiet
if [ $? -ne 0 ]; then
  echo "âŒ ESLint errors found. Run 'npm run lint' to see details."
  exit 1
fi

# 4. Check for secrets/tokens
echo "ğŸ” Security check..."
for file in $STAGED_FILES; do
  if [ -f "$file" ]; then
    # Check for common secret patterns
    if grep -qE "(api[_-]?key|apikey|secret|token|password|pwd|auth|credential)['\"]?\s*[:=]\s*['\"][^'\"]{10,}['\"]" "$file"; then
      echo "âš ï¸  Warning: Possible secret detected in $file"
      echo "   Please review and use environment variables instead"
      read -p "   Continue anyway? (y/N): " -n 1 -r
      echo
      if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
      fi
    fi
  fi
done

echo "âœ… Pre-commit checks passed!"