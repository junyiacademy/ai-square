#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

cd frontend

# ===========================================
# Pre-push Hook - CI/CD Protection
# Goal: Prevent CI/CD failures (< 30 seconds)
# ===========================================

echo "ğŸš€ Running pre-push validation..."
echo "   (This prevents CI/CD failures)"

# 1. Full TypeScript check
echo "ğŸ” TypeScript check (full project)..."
npm run typecheck
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript errors found. Please fix before pushing."
  echo "ğŸ’¡ Run 'npm run typecheck' to see all errors"
  exit 1
fi

# 2. Full ESLint check
echo "ğŸ“‹ ESLint check (full project)..."
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ ESLint errors found. Please fix before pushing."
  echo "ğŸ’¡ Run 'npm run lint' to see all errors"
  exit 1
fi

# 3. Critical tests - API routes only (fast)
echo "ğŸ§ª Running API tests (~5 seconds)..."
npm test -- src/app/api --bail --silent 2>/dev/null
if [ $? -ne 0 ]; then
  echo "âŒ API tests failed. Please fix before pushing."
  echo "ğŸ’¡ Run 'npm test src/app/api' to see failing tests"
  exit 1
fi

# 4. Optional: Full build check (can be skipped with --no-build flag)
if [ "$1" != "--no-build" ]; then
  echo "ğŸ—ï¸  Build validation (~35 seconds)..."
  echo "   (Skip with: git push --no-build)"
  npm run build > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    echo "âŒ Build failed. Please fix before pushing."
    echo "ğŸ’¡ Run 'npm run build' to see build errors"
    exit 1
  fi
else
  echo "âš ï¸  Skipping build check (--no-build flag used)"
fi

echo "âœ… All pre-push checks passed!"
echo "ğŸ¯ Pushing to remote... CI/CD should pass!"

# Optional: Show what will be pushed
echo ""
echo "ğŸ“¦ Commits to be pushed:"
git log --oneline @{u}..HEAD | head -5
echo ""