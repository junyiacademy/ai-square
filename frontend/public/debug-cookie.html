<!DOCTYPE html>
<html>
<head>
    <title>Cookie Debug</title>
</head>
<body>
    <h1>Cookie Debug Tool</h1>
    
    <button onclick="testDirectLogin()">1. Direct Login (No wrapper)</button>
    <button onclick="testWrappedLogin()">2. Wrapped Login (authenticatedFetch style)</button>
    <button onclick="testCheckAuth()">3. Check Auth Status</button>
    <button onclick="showAllInfo()">4. Show All Info</button>
    <button onclick="clearAll()">5. Clear Everything</button>
    
    <h2>Results:</h2>
    <pre id="results"></pre>
    
    <script>
        const results = document.getElementById('results');
        
        function log(msg, data) {
            results.textContent += `\n${msg}\n`;
            if (data) {
                results.textContent += JSON.stringify(data, null, 2) + '\n';
            }
            console.log(msg, data);
        }
        
        async function testDirectLogin() {
            log('=== Testing Direct Login (No wrapper) ===');
            
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    email: 'student@example.com',
                    password: 'student123',
                    rememberMe: false
                })
            });
            
            const data = await response.json();
            log('Response Status:', response.status);
            log('Response Data:', data);
            
            // Check response headers
            const setCookie = response.headers.get('set-cookie');
            log('Set-Cookie header:', setCookie || 'None visible (expected for httpOnly)');
            
            // Wait and check auth
            setTimeout(async () => {
                log('--- Checking auth after login ---');
                await testCheckAuth();
            }, 1000);
        }
        
        async function testWrappedLogin() {
            log('=== Testing Wrapped Login (authenticatedFetch style) ===');
            
            // Simulate authenticatedFetch
            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    email: 'student@example.com',
                    password: 'student123',
                    rememberMe: false
                })
            };
            
            const response = await fetch('/api/auth/login', options);
            const data = await response.json();
            
            log('Response Status:', response.status);
            log('Response Data:', data);
            
            // Wait and check auth
            setTimeout(async () => {
                log('--- Checking auth after wrapped login ---');
                await testCheckAuth();
            }, 1000);
        }
        
        async function testCheckAuth() {
            log('=== Checking Auth Status ===');
            
            const response = await fetch('/api/auth/check', {
                credentials: 'include'
            });
            
            const data = await response.json();
            log('Auth Check Status:', response.status);
            log('Auth Check Data:', data);
            
            // Also test PBL API
            log('--- Testing PBL API ---');
            const pblResponse = await fetch('/api/pbl/scenarios/d40d08e3-ceda-4ff2-8c68-de535331688b/programs', {
                credentials: 'include'
            });
            
            log('PBL API Status:', pblResponse.status);
            if (pblResponse.ok) {
                const pblData = await pblResponse.json();
                log('PBL API Success:', { programs: pblData.data?.programs?.length || 0 });
            } else {
                log('PBL API Failed');
            }
        }
        
        function showAllInfo() {
            log('=== All Browser Info ===');
            log('document.cookie:', document.cookie || '(empty - httpOnly cookies not visible)');
            log('localStorage.isLoggedIn:', localStorage.getItem('isLoggedIn'));
            log('localStorage.user:', localStorage.getItem('user'));
            log('window.location:', {
                href: window.location.href,
                origin: window.location.origin,
                host: window.location.host,
                hostname: window.location.hostname,
                port: window.location.port
            });
        }
        
        function clearAll() {
            log('=== Clearing Everything ===');
            localStorage.clear();
            sessionStorage.clear();
            // Can't clear httpOnly cookies from JavaScript
            log('Cleared localStorage and sessionStorage');
            log('Note: httpOnly cookies cannot be cleared from JavaScript');
        }
        
        // Show initial state
        showAllInfo();
    </script>
</body>
</html>